<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel - SMART THITTAM</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <main>
        <div class="container" style="max-width:700px;margin:2rem auto;">
            <div class="card fade-in" style="padding:2rem;">
                <h2 class="section-title mb-4">Admin Panel</h2>
                <h3>Add Scheme</h3>
                <form id="addSchemeForm">
                    <input type="text" name="title" class="input" placeholder="Title" required>
                    <input type="text" name="description" class="input" placeholder="Description" required>
                    <input type="text" name="category" class="input" placeholder="Category" required>
                    <select name="district" class="input" required>
                        <option value="All Districts">All Districts</option>
                        <option value="Chennai">Chennai</option>
                        <option value="Coimbatore">Coimbatore</option>
                        <option value="Madurai">Madurai</option>
                        <option value="Salem">Salem</option>
                        <option value="Tiruchirappalli">Tiruchirappalli</option>
                        <option value="Vellore">Vellore</option>
                        <option value="Erode">Erode</option>
                        <option value="Tiruppur">Tiruppur</option>
                        <option value="Tirunelveli">Tirunelveli</option>
                        <option value="Thoothukkudi">Thoothukkudi</option>
                        <option value="Dindigul">Dindigul</option>
                        <option value="Thanjavur">Thanjavur</option>
                        <option value="Villupuram">Villupuram</option>
                        <option value="Kanchipuram">Kanchipuram</option>
                        <option value="Cuddalore">Cuddalore</option>
                        <option value="Pudukkottai">Pudukkottai</option>
                        <option value="Sivaganga">Sivaganga</option>
                        <option value="Ramanathapuram">Ramanathapuram</option>
                        <option value="Virudhunagar">Virudhunagar</option>
                        <option value="Karur">Karur</option>
                        <option value="Namakkal">Namakkal</option>
                        <option value="Theni">Theni</option>
                        <option value="Krishnagiri">Krishnagiri</option>
                        <option value="Dharmapuri">Dharmapuri</option>
                        <option value="Tiruvannamalai">Tiruvannamalai</option>
                        <option value="Ariyalur">Ariyalur</option>
                        <option value="Perambalur">Perambalur</option>
                        <option value="Nagapattinam">Nagapattinam</option>
                        <option value="Tiruvarur">Tiruvarur</option>
                        <option value="Nilgiris">Nilgiris</option>
                        <option value="Tenkasi">Tenkasi</option>
                        <option value="Chengalpattu">Chengalpattu</option>
                        <option value="Ranipet">Ranipet</option>
                        <option value="Tirupathur">Tirupathur</option>
                        <option value="Mayiladuthurai">Mayiladuthurai</option>
                        <option value="Kallakurichi">Kallakurichi</option>
                    </select>
                    <select name="level" class="input" required>
                        <option value="">Select Level</option>
                        <option value="State">State</option>
                        <option value="Central">Central</option>
                        <option value="UT">UT</option>
                    </select>
                    <input type="number" name="budgetAmount" class="input" placeholder="Budget Amount" required>
                    <input type="text" name="budgetCurrency" class="input" placeholder="Budget Currency" value="INR" required>
                    <input type="text" name="governmentBody" class="input" placeholder="Government Body" required>
                    <select name="status" class="input" required>
                        <option value="">Select Status</option>
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                    <input type="text" name="tags" class="input" placeholder="Tags (comma separated)">
                    <input type="text" name="benefits" class="input" placeholder="Benefits (comma separated)">
                    <input type="text" name="documents" class="input" placeholder="Documents (comma separated)">
                    <input type="text" name="applicationProcess" class="input" placeholder="Application Process" required>
                    <input type="text" name="deadline" class="input" placeholder="Deadline (optional)">
                    <!-- Eligibility -->
                    <h4>Eligibility</h4>
                    <input type="number" name="minAge" class="input" placeholder="Min Age" required>
                    <input type="number" name="maxAge" class="input" placeholder="Max Age" required>
                    <input type="number" name="minIncome" class="input" placeholder="Min Income" required>
                    <input type="number" name="maxIncome" class="input" placeholder="Max Income" required>
                    <select name="education" class="input" required>
                        <option value="">Select Education</option>
                        <option value="None">None</option>
                        <option value="Primary">Primary</option>
                        <option value="Secondary">Secondary</option>
                        <option value="12th Pass">12th Pass</option>
                        <option value="Graduate">Graduate</option>
                        <option value="Postgraduate">Postgraduate</option>
                    </select>
                    <select name="gender" class="input" required>
                        <option value="">Select Gender</option>
                        <option value="Any">Any</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                    <input type="text" name="location" class="input" placeholder="Location (Urban/Rural/Both)" required>
                    <input type="text" name="occupation" class="input" placeholder="Occupation" required>
                    <input type="text" name="otherRequirements" class="input" placeholder="Other Requirements (comma separated)">
                    <!-- Contact Info -->
                    <h4>Contact Info</h4>
                    <input type="text" name="contactPhone" class="input" placeholder="Contact Phone">
                    <input type="email" name="contactEmail" class="input" placeholder="Contact Email">
                    <input type="text" name="contactWebsite" class="input" placeholder="Contact Website">
                    <input type="text" name="contactAddress" class="input" placeholder="Contact Address">
                    <!-- Apply Info -->
                    <h4>Apply Info</h4>
                    <input type="text" name="applySite" class="input" placeholder="Apply Site">
                    <input type="text" name="applyHow" class="input" placeholder="How to Apply">
                    <button type="submit" class="btn btn-primary w-full">Add Scheme</button>
                </form>
                <hr class="my-4">
                <h3>Edit/Delete Scheme</h3>
                <input type="text" id="schemeId" class="input" placeholder="Scheme ID">
                <button onclick="editScheme()" class="btn btn-secondary">Edit</button>
                <button onclick="deleteScheme()" class="btn btn-secondary">Delete</button>
                <button id="filter-btn">Apply Filters</button>
            </div>
        </div>
    </main>
    <script>
    const user = JSON.parse(localStorage.getItem('user'));
if (!user || user.role !== 'admin') {
    alert('Access denied! Only admin can view this page.');
    window.location.href = 'index.html'; // Redirect to home
}

let editingSchemeId = null;

// Add Scheme
document.getElementById('addSchemeForm').onsubmit = async (e) => {
    e.preventDefault();
    const user = JSON.parse(localStorage.getItem('user'));
    const token = user?.token;
    if (!token) {
        alert('You must be logged in as admin.');
        return;
    }
    const form = e.target;
    // Build the scheme object as per seedData.js
    const scheme = {
        title: form.title.value,
        description: form.description.value,
        category: form.category.value,
        district: form.district.value,
        level: form.level.value,
        eligibility: {
            age: { min: Number(form.minAge.value), max: Number(form.maxAge.value) },
            income: { min: Number(form.minIncome.value), max: Number(form.maxIncome.value) },
            education: form.education.value,
            gender: form.gender.value,
            location: form.location.value,
            occupation: form.occupation.value,
            otherRequirements: form.otherRequirements.value ? form.otherRequirements.value.split(',').map(s => s.trim()) : []
        },
        benefits: form.benefits.value ? form.benefits.value.split(',').map(s => s.trim()) : [],
        documents: form.documents.value ? form.documents.value.split(',').map(s => s.trim()) : [],
        applicationProcess: form.applicationProcess.value,
        deadline: form.deadline.value || null,
        status: form.status.value,
        governmentBody: form.governmentBody.value,
        contactInfo: {
            phone: form.contactPhone.value,
            email: form.contactEmail.value,
            website: form.contactWebsite.value,
            address: form.contactAddress.value
        },
        budget: { amount: Number(form.budgetAmount.value), currency: form.budgetCurrency.value },
        tags: form.tags.value ? form.tags.value.split(',').map(s => s.trim()) : [],
        featured: false,
        views: 0,
        applications: 0,
        apply: {
            site: form.applySite.value,
            how: form.applyHow.value
        }
    };

    let url = 'https://smartscheme-backend.onrender.com/api/v2/schemes';
    let method = 'POST';

    // If editing, update instead of create
    if (editingSchemeId) {
    url = `https://smartscheme-backend.onrender.com/api/v2/schemes/${editingSchemeId}`;
        method = 'PUT';
    }

    const res = await fetch(url, {
        method,
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(scheme)
    });
    const result = await res.json();
    if (res.ok) {
        alert(result.message || (editingSchemeId ? 'Scheme updated!' : 'Scheme added!'));
        window.location.href = 'schemes.html'; // Redirect to schemes list
    } else {
        alert(result.message || 'Failed to save scheme');
    }
    editingSchemeId = null; // Reset after submit
};

// Edit Scheme
async function editScheme() {
    const schemeId = document.getElementById('schemeId').value.trim();
    const token = user?.token;
    if (!schemeId) {
        alert('Please enter a Scheme ID.');
        return;
    }
    // Fetch existing scheme data
    const getRes = await fetch(`https://smartscheme-backend.onrender.com/api/v2/schemes/${schemeId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!getRes.ok) {
        alert('Scheme not found.');
        return;
    }
    const scheme = await getRes.json();

    // Auto-fill the form fields with the fetched scheme data
    const form = document.getElementById('addSchemeForm');
    form.title.value = scheme.title || '';
    form.description.value = scheme.description || '';
    form.category.value = scheme.category || '';
    form.district.value = scheme.district || '';
    form.level.value = scheme.level || '';
    form.budgetAmount.value = scheme.budget?.amount || '';
    form.budgetCurrency.value = scheme.budget?.currency || '';
    form.governmentBody.value = scheme.governmentBody || '';
    form.status.value = scheme.status || '';
    form.tags.value = (scheme.tags || []).join(', ');
    form.benefits.value = (scheme.benefits || []).join(', ');
    form.documents.value = (scheme.documents || []).join(', ');
    form.applicationProcess.value = scheme.applicationProcess || '';
    form.deadline.value = scheme.deadline || '';

    // Eligibility
    form.minAge.value = scheme.eligibility?.age?.min || '';
    form.maxAge.value = scheme.eligibility?.age?.max || '';
    form.minIncome.value = scheme.eligibility?.income?.min || '';
    form.maxIncome.value = scheme.eligibility?.income?.max || '';
    form.education.value = scheme.eligibility?.education || '';
    form.gender.value = scheme.eligibility?.gender || '';
    form.location.value = scheme.eligibility?.location || '';
    form.occupation.value = scheme.eligibility?.occupation || '';
    form.otherRequirements.value = (scheme.eligibility?.otherRequirements || []).join(', ');

    // Contact Info
    form.contactPhone.value = scheme.contactInfo?.phone || '';
    form.contactEmail.value = scheme.contactInfo?.email || '';
    form.contactWebsite.value = scheme.contactInfo?.website || '';
    form.contactAddress.value = scheme.contactInfo?.address || '';

    // Apply Info
    form.applySite.value = scheme.apply?.site || '';
    form.applyHow.value = scheme.apply?.how || '';

    editingSchemeId = schemeId;

    alert('Scheme data loaded. You can now edit and submit the form to update.');
}

// Delete Scheme
async function deleteScheme() {
    const schemeId = document.getElementById('schemeId').value.trim();
    const token = user?.token;
    if (!schemeId) {
        alert('Please enter a Scheme ID.');
        return;
    }
    if (!confirm('Are you sure you want to delete this scheme?')) return;
    const res = await fetch(`https://smartscheme-backend.onrender.com/api/v2/schemes/${schemeId}`, {
        method: 'DELETE',
        headers: {
            'Authorization': `Bearer ${token}`
        }
    });
    const result = await res.json();
    alert(result.message || (res.ok ? 'Scheme deleted!' : 'Failed to delete scheme'));
}
    </script>
</body>
</html>